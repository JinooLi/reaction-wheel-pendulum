# Reaction Wheel Pendulum

1. 우선 이 소프트웨어가 어떤 기능들로 구성되어야 하는지 설계한다.
    - 제어 주기와 연산 시간에 유의하며 구성하자.
2. 각각의 기능을 구현한다.

## 시스템의 input은 무엇인가?
정지해있는 시스템이 움직일 것이다. 각운동량 보존 법칙에 따라, 바퀴의 각운동량과 진자의 각운동량을 합해서 0이 된다고 가정한다.
$$L_w + L_p = 0$$
이것을 시간에 대해 미분해보자.
$$\frac{dL_w}{dt} + \frac{dL_p}{dt} = I_w\frac{d\omega_w}{dt} + I_p\frac{d\omega_p}{dt} = 0$$
$$I_w\alpha_w + I_p\alpha_p = 0 $$
$$ \alpha_p = -\frac{I_w}{I_p}\alpha_w$$
그렇다. 진자의 각가속도는 바퀴의 각가속도로 제어할 수 있다.  
따라서 시스템의 input은 바퀴의 각가속도이다.

그런데, 각각의 관성 모멘트를 굳이 구할 필요가 있을까? 그냥 비례 상수를 알아내면 되는 것이 아닌가? 또한, 시스템의 입력과 모터를 통해 만드는 출력은 비례하기 때문에 그냥 P 제어만 하여 상수만 좀 잡으면 되지 않을까?
$$\alpha_p = -R \alpha_w$$
나중에 이렇게 대충 제어한 데이터를 모아 R을 구할 수 있겠다.

## 제어를 할 땐 무슨 기능이 필요한가?
센서로부터 상태를 읽어오는 기능, 읽은 상태로부터 제어 입력을 계산하는 기능, 제어 입력을 모터에 전달하는 기능. 이렇게 세 가지 기능이 필요하다.   
따라서, 각각의 기능을 추상적으로 정의한다.
또한, 제어 주기를 맞춰주는 기능도 필요하다.

### 센서로부터 상태를 읽어오는 기능
센서는 IMU(관성 측정 장치)로, 진자의 각도를 읽어온다.  
결국, input은 없고, output은 진자의 각도와 각속도인 함수를 정의한다.  
 이것은 칼만필터를 통해 보정을 할 필요성이 있다.  

### 읽은 상태로부터 제어 입력을 계산하는 기능
제어 입력은 바퀴의 각가속도이다.   
따라서 input은 진자의 각도와 각속도이고, output은 바퀴의 각가속도인 함수를 정의한다.  
제어 기법이야 마음대로 하면 될 것이다.

### 제어 입력을 모터에 전달하는 기능
모터는 PWM(펄스 폭 변조) 신호로 제어한다.  
따라서 input은 바퀴의 각가속도이고, output은 PWM 신호인 함수를 정의한다.   
이 기능은 따로 엔코더 값을 읽어오고 모터 제어를 알아서 하는 기능을 가지고 있어야 한다.  

### 제어 주기 만드는 방법
우선, 기본적인 while 루프를 만들고, 그 안에서 각 제어 주기의 시간이 될 때까지 기다리는 함수를 만들어 넣는다.
이 함수는 현재 시간을 읽어와서 다음 제어 주기까지 sleep한다.